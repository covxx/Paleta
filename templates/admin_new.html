{% extends "base.html" %}

{% block title %}Admin Panel - Inventory Management{% endblock %}

{% block extra_css %}
<style>
    .admin-hero {
        background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-700) 100%);
        color: white;
        padding: 3rem 0;
        margin: -2rem -1rem 3rem -1rem;
        text-align: center;
    }

    .admin-hero h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .admin-hero p {
        font-size: 1.25rem;
        opacity: 0.9;
    }

    .admin-nav {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .nav-tabs {
        display: flex;
        list-style: none;
        margin: 0;
        padding: 0;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
    }

    .nav-tabs li {
        flex: 1;
    }

    .nav-tabs a {
        display: block;
        padding: 1rem 1.5rem;
        text-decoration: none;
        color: var(--gray-600);
        font-weight: 500;
        text-align: center;
        transition: all 0.2s ease;
        border-bottom: 3px solid transparent;
    }

    .nav-tabs a:hover {
        background: var(--gray-100);
        color: var(--gray-800);
    }

    .nav-tabs a.active {
        background: white;
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .tab-content {
        display: none;
        padding: 2rem;
    }

    .tab-content.active {
        display: block;
    }

    .section {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .section-header h3 {
        margin: 0;
        color: var(--gray-800);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-body {
        padding: 2rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .form-control:read-only {
        background: var(--gray-50);
        color: var(--gray-600);
    }

    .table-container {
        overflow-x: auto;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .table thead th {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        border: none;
        font-weight: 600;
        color: var(--gray-700);
        padding: 1rem;
        text-align: left;
    }

    .table tbody td {
        border: none;
        padding: 1rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .table tbody tr:hover {
        background: var(--gray-50);
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        text-align: center;
        border-left: 4px solid var(--primary-color);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--gray-600);
        font-weight: 500;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-active {
        background: var(--success-color);
        color: white;
    }

    .status-inactive {
        background: var(--gray-400);
        color: white;
    }

    .status-expired {
        background: var(--danger-color);
        color: white;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--gray-500);
    }

    .alert {
        border: none;
        border-radius: var(--border-radius);
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
    }

    .alert-danger {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
    }

    .alert-info {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-600);
        text-decoration: none;
        margin-bottom: 2rem;
        font-weight: 500;
        transition: color 0.2s ease;
    }

    .back-link:hover {
        color: var(--primary-color);
    }

    .section-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .user-info {
        background: var(--gray-50);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .user-details {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .user-text {
        display: flex;
        flex-direction: column;
    }

    .user-name {
        font-weight: 600;
        color: var(--gray-800);
    }

    .user-email {
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    @media (max-width: 768px) {
        .nav-tabs {
            flex-direction: column;
        }

        .nav-tabs li {
            flex: none;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .action-buttons {
            flex-direction: column;
        }

        .user-info {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="admin-hero">
    <div class="admin-hero-content">
        <h1><i class="fas fa-cog"></i> Admin Panel</h1>
        <p>Manage your inventory system settings and data</p>
    </div>
</div>

<!-- User Info -->
<div class="user-info">
    <div class="user-details">
        <div class="user-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="user-text">
            <div class="user-name">Admin User</div>
            <div class="user-email">admin@company.com</div>
        </div>
    </div>
    <a href="/admin/logout" class="btn btn-outline-primary">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>

<!-- Navigation Tabs -->
<div class="admin-nav">
    <ul class="nav-tabs">
        <li><a href="#dashboard" class="active" onclick="showTab('dashboard')">Dashboard</a></li>
        <li><a href="#items" onclick="showTab('items')">Items</a></li>
        <li><a href="#lots" onclick="showTab('lots')">LOTs</a></li>
        <li><a href="#vendors" onclick="showTab('vendors')">Vendors</a></li>
        <li><a href="#printers" onclick="showTab('printers')">Printers</a></li>
        <li><a href="#users" onclick="showTab('users')" id="usersTab" style="display: none;">Users</a></li>
        <li><a href="#active-users" onclick="showTab('active-users')">Active Users</a></li>
        <li><a href="#analytics" onclick="showTab('analytics')">Analytics</a></li>
    </ul>
</div>

<!-- Dashboard Tab -->
<div id="dashboard" class="tab-content active">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalItems">0</div>
            <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalLots">0</div>
            <div class="stat-label">Active LOTs</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalVendors">0</div>
            <div class="stat-label">Vendors</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalPrinters">0</div>
            <div class="stat-label">Printers</div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-chart-line"></i> Recent Activity</h3>
        </div>
        <div class="section-body">
            <div class="loading">
                <div class="spinner"></div>
                Loading recent activity...
            </div>
        </div>
    </div>
</div>

<!-- Items Tab -->
<div id="items" class="tab-content">
    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-boxes"></i> Items Management</h3>
        </div>
        <div class="section-body">
            <form id="itemForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="itemName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Item Code (Numerical)</label>
                        <input type="text" id="itemCode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">GTIN</label>
                        <input type="text" id="itemGtin" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" id="itemCategory" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="itemDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="section-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearItemForm()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Existing Items</h3>
        </div>
        <div class="section-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Name</th>
                            <th>GTIN</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                Loading items...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- LOTs Tab -->
<div id="lots" class="tab-content">
    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-barcode"></i> LOT Management</h3>
        </div>
        <div class="section-body">
            <form id="lotForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Item</label>
                        <select id="lotItem" class="form-control" required>
                            <option value="">Select Item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="lotQuantity" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit Type</label>
                        <select id="lotUnitType" class="form-control" required>
                            <option value="cases">Cases</option>
                            <option value="pounds">Pounds</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expiry Date (Auto-set to 10 days)</label>
                        <input type="date" id="lotExpiry" class="form-control" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="lotNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="section-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create LOT
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearLotForm()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Existing LOTs</h3>
        </div>
        <div class="section-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>LOT Code</th>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lotsTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Loading LOTs...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Vendors Tab -->
<div id="vendors" class="tab-content">
    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-truck"></i> Vendor Management</h3>
        </div>
        <div class="section-body">
            <form id="vendorForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Vendor Name</label>
                        <input type="text" id="vendorName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Person</label>
                        <input type="text" id="vendorContact" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="vendorEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="vendorPhone" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="vendorAddress" class="form-control" rows="3"></textarea>
                </div>
                <div class="section-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Vendor
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearVendorForm()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Existing Vendors</h3>
        </div>
        <div class="section-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                Loading vendors...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Printers Tab -->
<div id="printers" class="tab-content">
    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-print"></i> Printer Management</h3>
        </div>
        <div class="section-body">
            <form id="printerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Printer Name</label>
                        <input type="text" id="printerName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">IP Address</label>
                        <input type="text" id="printerIp" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" id="printerPort" class="form-control" value="9100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" id="printerModel" class="form-control">
                    </div>
                </div>
                <div class="section-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Printer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearPrinterForm()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Existing Printers</h3>
        </div>
        <div class="section-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>IP Address</th>
                            <th>Port</th>
                            <th>Model</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="printersTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Loading printers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Active Users Tab -->
<div id="active-users" class="tab-content">
    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-users"></i> Active Users</h3>
        </div>
        <div class="section-body">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalActiveUsers">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Email</th>
                            <th>IP Address</th>
                            <th>Last Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activeUsersTableBody">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                Loading active users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section-actions">
                <button class="btn btn-info" onclick="loadActiveUsers()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn btn-warning" onclick="clearInactiveSessions()">
                    <i class="fas fa-trash"></i> Clear Inactive
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Tab -->
<div id="analytics" class="tab-content">
    <div class="section">
        <div class="section-header">
            <h3><i class="fas fa-chart-bar"></i> System Analytics</h3>
        </div>
        <div class="section-body">
            <div class="loading">
                <div class="spinner"></div>
                Analytics coming soon...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let items = [];
    let lots = [];
    let vendors = [];
    let printers = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadItems();
        loadLots();
        loadVendors();
        loadPrinters();
        loadActiveUsers();
        setAutoExpiryDate();
        setupFormHandlers();
    });

    // Tab switching
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.nav-tabs a').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');

        // Load data for specific tabs
        if (tabName === 'items') {
            loadItems();
        } else if (tabName === 'lots') {
            loadLots();
            loadItemsForSelect();
            setAutoExpiryDate();
        } else if (tabName === 'vendors') {
            loadVendors();
        } else if (tabName === 'printers') {
            loadPrinters();
        } else if (tabName === 'active-users') {
            loadActiveUsers();
        }
    }

    // Dashboard functions
    async function loadDashboardData() {
        try {
            const [itemsRes, lotsRes, vendorsRes, printersRes] = await Promise.all([
                fetch('/api/items'),
                fetch('/api/lots'),
                fetch('/api/vendors'),
                fetch('/api/printers')
            ]);

            const itemsData = await itemsRes.json();
            const lotsData = await lotsRes.json();
            const vendorsData = await vendorsRes.json();
            const printersData = await printersRes.json();

            document.getElementById('totalItems').textContent = itemsData.length;
            document.getElementById('totalLots').textContent = lotsData.length;
            document.getElementById('totalVendors').textContent = vendorsData.length;
            document.getElementById('totalPrinters').textContent = printersData.length;
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    // Items management
    async function loadItems() {
        try {
            const response = await fetch('/api/items');
            items = await response.json();
            displayItems();
        } catch (error) {
            showAlert('itemsTableBody', 'Error loading items: ' + error.message, 'danger');
        }
    }

    function displayItems() {
        const tbody = document.getElementById('itemsTableBody');
        
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No items found</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(item => `
            <tr>
                <td>${item.item_code}</td>
                <td>${item.name}</td>
                <td>${item.gtin}</td>
                <td>${item.category || 'N/A'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editItem(${item.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // LOTs management
    async function loadLots() {
        try {
            const response = await fetch('/api/lots');
            lots = await response.json();
            displayLots();
        } catch (error) {
            showAlert('lotsTableBody', 'Error loading lots: ' + error.message, 'danger');
        }
    }

    function displayLots() {
        const tbody = document.getElementById('lotsTableBody');
        
        if (lots.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No LOTs found</td></tr>';
            return;
        }

        tbody.innerHTML = lots.map(lot => {
            const isExpired = lot.expiry_date && new Date(lot.expiry_date) < new Date();
            const statusBadge = isExpired ? 
                '<span class="status-badge status-expired">Expired</span>' : 
                '<span class="status-badge status-active">Active</span>';

            // Safely access item properties with fallbacks
            const itemName = lot.item && lot.item.name ? lot.item.name : 'Unknown Item';
            const itemCode = lot.item && lot.item.item_code ? lot.item.item_code : 'N/A';
            const quantity = lot.quantity || 0;
            const unitType = lot.unit_type || 'units';

            return `
                <tr>
                    <td>${lot.lot_code}</td>
                    <td>${itemName} (${itemCode})</td>
                    <td>${quantity} ${unitType}</td>
                    <td>${lot.expiry_date ? new Date(lot.expiry_date).toLocaleDateString() : 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editLot('${lot.lot_code}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Vendors management
    async function loadVendors() {
        try {
            const response = await fetch('/api/vendors');
            vendors = await response.json();
            displayVendors();
        } catch (error) {
            showAlert('vendorsTableBody', 'Error loading vendors: ' + error.message, 'danger');
        }
    }

    function displayVendors() {
        const tbody = document.getElementById('vendorsTableBody');
        
        if (vendors.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No vendors found</td></tr>';
            return;
        }

        tbody.innerHTML = vendors.map(vendor => `
            <tr>
                <td>${vendor.name}</td>
                <td>${vendor.contact_person || 'N/A'}</td>
                <td>${vendor.email || 'N/A'}</td>
                <td>${vendor.phone || 'N/A'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editVendor(${vendor.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteVendor(${vendor.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Printers management
    async function loadPrinters() {
        try {
            const response = await fetch('/api/printers');
            printers = await response.json();
            displayPrinters();
        } catch (error) {
            showAlert('printersTableBody', 'Error loading printers: ' + error.message, 'danger');
        }
    }

    function displayPrinters() {
        const tbody = document.getElementById('printersTableBody');
        
        if (printers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No printers found</td></tr>';
            return;
        }

        tbody.innerHTML = printers.map(printer => `
            <tr>
                <td>${printer.name}</td>
                <td>${printer.ip_address}</td>
                <td>${printer.port}</td>
                <td>${printer.model || 'N/A'}</td>
                <td>
                    <span class="status-badge status-active">Active</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editPrinter(${printer.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-info btn-sm" onclick="testPrinter(${printer.id})">
                            <i class="fas fa-test-tube"></i> Test
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePrinter(${printer.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Active users management
    async function loadActiveUsers() {
        try {
            const response = await fetch('/api/active-users');
            const data = await response.json();
            
            if (data.success) {
                displayActiveUsers(data.active_users);
                updateActiveUsersStats(data.total_active, data.active_users.length);
            } else {
                showAlert('activeUsersTableBody', 'Error loading active users: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('activeUsersTableBody', 'Error loading active users: ' + error.message, 'danger');
        }
    }

    function displayActiveUsers(users) {
        const tbody = document.getElementById('activeUsersTableBody');
        
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No active users</td></tr>';
            return;
        }
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.user_id}</td>
                <td>${user.email}</td>
                <td>${user.ip_address}</td>
                <td>${user.minutes_ago} minutes ago</td>
                <td>
                    <span class="status-badge status-active">Active</span>
                </td>
            </tr>
        `).join('');
    }

    function updateActiveUsersStats(totalActive, currentActive) {
        document.getElementById('totalActiveUsers').textContent = currentActive;
        document.getElementById('totalSessions').textContent = totalActive;
    }

    // Form handlers
    function setupFormHandlers() {
        // Item form
        document.getElementById('itemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addItem();
        });

        // LOT form
        document.getElementById('lotForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addLot();
        });

        // Vendor form
        document.getElementById('vendorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addVendor();
        });

        // Printer form
        document.getElementById('printerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addPrinter();
        });
    }

    // Add functions
    async function addItem() {
        const formData = {
            name: document.getElementById('itemName').value,
            item_code: document.getElementById('itemCode').value,
            gtin: document.getElementById('itemGtin').value,
            category: document.getElementById('itemCategory').value,
            description: document.getElementById('itemDescription').value
        };

        try {
            const response = await fetch('/api/items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('itemsTableBody', 'Item added successfully', 'success');
                clearItemForm();
                loadItems();
                loadDashboardData();
            } else {
                showAlert('itemsTableBody', 'Error adding item: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('itemsTableBody', 'Error adding item: ' + error.message, 'danger');
        }
    }

    async function addLot() {
        const formData = {
            item_id: document.getElementById('lotItem').value,
            quantity: document.getElementById('lotQuantity').value,
            unit_type: document.getElementById('lotUnitType').value,
            expiry_date: document.getElementById('lotExpiry').value,
            notes: document.getElementById('lotNotes').value
        };

        try {
            const response = await fetch('/api/lots', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('lotsTableBody', 'LOT created successfully', 'success');
                clearLotForm();
                loadLots();
                loadDashboardData();
            } else {
                showAlert('lotsTableBody', 'Error creating LOT: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('lotsTableBody', 'Error creating LOT: ' + error.message, 'danger');
        }
    }

    async function addVendor() {
        const formData = {
            name: document.getElementById('vendorName').value,
            contact_person: document.getElementById('vendorContact').value,
            email: document.getElementById('vendorEmail').value,
            phone: document.getElementById('vendorPhone').value,
            address: document.getElementById('vendorAddress').value
        };

        try {
            const response = await fetch('/api/vendors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('vendorsTableBody', 'Vendor added successfully', 'success');
                clearVendorForm();
                loadVendors();
                loadDashboardData();
            } else {
                showAlert('vendorsTableBody', 'Error adding vendor: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('vendorsTableBody', 'Error adding vendor: ' + error.message, 'danger');
        }
    }

    async function addPrinter() {
        const formData = {
            name: document.getElementById('printerName').value,
            ip_address: document.getElementById('printerIp').value,
            port: document.getElementById('printerPort').value,
            model: document.getElementById('printerModel').value
        };

        try {
            const response = await fetch('/api/printers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('printersTableBody', 'Printer added successfully', 'success');
                clearPrinterForm();
                loadPrinters();
                loadDashboardData();
            } else {
                showAlert('printersTableBody', 'Error adding printer: ' + result.error, 'danger');
            }
        } catch (error) {
            showAlert('printersTableBody', 'Error adding printer: ' + error.message, 'danger');
        }
    }

    // Clear form functions
    function clearItemForm() {
        document.getElementById('itemForm').reset();
    }

    function clearLotForm() {
        document.getElementById('lotForm').reset();
        setAutoExpiryDate();
    }

    function clearVendorForm() {
        document.getElementById('vendorForm').reset();
    }

    function clearPrinterForm() {
        document.getElementById('printerForm').reset();
        document.getElementById('printerPort').value = '9100';
    }

    // Utility functions
    function setAutoExpiryDate() {
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 10);
        const formattedDate = expiryDate.toISOString().split('T')[0];
        document.getElementById('lotExpiry').value = formattedDate;
    }

    async function loadItemsForSelect() {
        try {
            const response = await fetch('/api/items');
            const itemsData = await response.json();
            
            const select = document.getElementById('lotItem');
            select.innerHTML = '<option value="">Select Item...</option>' +
                itemsData.map(item => `<option value="${item.id}">${item.name} (${item.item_code})</option>`).join('');
        } catch (error) {
            console.error('Error loading items for select:', error);
        }
    }

    // Placeholder functions for edit/delete operations
    function editItem(id) {
        showAlert('itemsTableBody', 'Edit functionality coming soon', 'info');
    }

    function deleteItem(id) {
        if (confirm('Are you sure you want to delete this item?')) {
            showAlert('itemsTableBody', 'Delete functionality coming soon', 'info');
        }
    }

    function editLot(lotCode) {
        showAlert('lotsTableBody', 'Edit functionality coming soon', 'info');
    }

    function editVendor(id) {
        showAlert('vendorsTableBody', 'Edit functionality coming soon', 'info');
    }

    function deleteVendor(id) {
        if (confirm('Are you sure you want to delete this vendor?')) {
            showAlert('vendorsTableBody', 'Delete functionality coming soon', 'info');
        }
    }

    function editPrinter(id) {
        showAlert('printersTableBody', 'Edit functionality coming soon', 'info');
    }

    function testPrinter(id) {
        showAlert('printersTableBody', 'Test functionality coming soon', 'info');
    }

    function deletePrinter(id) {
        if (confirm('Are you sure you want to delete this printer?')) {
            showAlert('printersTableBody', 'Delete functionality coming soon', 'info');
        }
    }

    function clearInactiveSessions() {
        if (!confirm('This will clear all inactive user sessions. Continue?')) {
            return;
        }
        
        showAlert('activeUsersTableBody', 'Inactive sessions cleared', 'success');
        loadActiveUsers();
    }
</script>
{% endblock %}
