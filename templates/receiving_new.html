{% extends "base.html" %}

{% block title %}Receiving Workflow - Inventory Management{% endblock %}

{% block extra_css %}
<style>
    .receiving-hero {
        background: linear-gradient(135deg, var(--info-color) 0%, var(--primary-color) 100%);
        color: white;
        padding: 3rem 0;
        margin: -2rem -1rem 3rem -1rem;
        text-align: center;
    }

    .receiving-hero h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .receiving-hero p {
        font-size: 1.25rem;
        opacity: 0.9;
    }

    .form-section {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .items-section {
        background: var(--gray-50);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .item-row {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 1rem;
        align-items: end;
    }

    .item-row:last-child {
        margin-bottom: 0;
    }

    .remove-item-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-item-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }

    .add-item-btn {
        background: var(--success-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }

    .add-item-btn:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    .receipt-preview {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow);
    }

    .receipt-header {
        text-align: center;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .receipt-header h3 {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .receipt-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--gray-100);
    }

    .receipt-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--primary-color);
    }

    .receipt-label {
        font-weight: 500;
        color: var(--gray-700);
    }

    .receipt-value {
        color: var(--gray-800);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .autocomplete-container {
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--gray-200);
        border-top: none;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid var(--gray-100);
        transition: background-color 0.2s ease;
    }

    .autocomplete-item:hover {
        background: var(--gray-50);
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .item-code {
        font-weight: 600;
        color: var(--primary-color);
    }

    .item-name {
        color: var(--gray-600);
        font-size: 0.9rem;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-success {
        background: var(--success-color);
        color: white;
    }

    .status-warning {
        background: var(--warning-color);
        color: white;
    }

    .status-danger {
        background: var(--danger-color);
        color: white;
    }

    @media (max-width: 768px) {
        .item-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="receiving-hero">
    <div class="receiving-hero-content">
        <h1><i class="fas fa-truck"></i> Receiving Workflow</h1>
        <p>Process incoming inventory and generate LOT codes with labels</p>
    </div>
</div>

<!-- Receiving Form -->
<div class="form-section">
    <h2 class="section-title">
        <i class="fas fa-clipboard-list"></i>
        Receiving Information
    </h2>
    
    <form id="receivingForm">
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Vendor</label>
                <select id="vendorSelect" class="form-control" required>
                    <option value="">Select Vendor...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Receiving Date</label>
                <input type="date" id="receivingDate" class="form-control" required>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Receiving Photo (Optional)</label>
            <input type="file" id="receivingPhoto" class="form-control" accept="image/*" capture="environment">
            <small class="form-text text-muted">Take a photo of the received items for documentation</small>
        </div>
    </form>
</div>

<!-- Items Section -->
<div class="items-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="section-title mb-0">
            <i class="fas fa-boxes"></i>
            Items to Receive
        </h3>
        <button type="button" class="add-item-btn" onclick="addItemRow()">
            <i class="fas fa-plus"></i>
            Add Item
        </button>
    </div>
    
    <div id="itemsContainer">
        <!-- Items will be added here dynamically -->
    </div>
</div>

<!-- Receipt Preview -->
<div class="form-section">
    <h3 class="section-title">
        <i class="fas fa-receipt"></i>
        Receipt Preview
    </h3>
    
    <div class="receipt-preview">
        <div class="receipt-header">
            <h3>Receiving Receipt</h3>
            <p id="receiptVendor">Vendor: Not selected</p>
            <p id="receiptDate">Date: Not set</p>
        </div>
        
        <div id="receiptItems">
            <div class="receipt-item">
                <span class="receipt-label">No items added yet</span>
                <span class="receipt-value">-</span>
            </div>
        </div>
        
        <div class="receipt-item">
            <span class="receipt-label">Total Items:</span>
            <span class="receipt-value" id="totalItems">0</span>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <button type="button" class="btn btn-primary" onclick="processReceiving()">
        <i class="fas fa-check"></i>
        Process Receiving
    </button>
    <button type="button" class="btn btn-secondary" onclick="clearForm()">
        <i class="fas fa-trash"></i>
        Clear Form
    </button>
    <button type="button" class="btn btn-info" onclick="printReceipt()">
        <i class="fas fa-print"></i>
        Print Receipt
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let vendors = [];
    let items = [];
    let currentReceipt = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadVendors();
        loadItems();
        setDefaultDate();
        addItemRow(); // Add first item row
    });

    // Set default date to today
    function setDefaultDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receivingDate').value = today;
    }

    // Load vendors
    async function loadVendors() {
        try {
            const response = await fetch('/api/vendors');
            vendors = await response.json();
            
            const select = document.getElementById('vendorSelect');
            select.innerHTML = '<option value="">Select Vendor...</option>' +
                vendors.map(vendor => `<option value="${vendor.id}">${vendor.name}</option>`).join('');
        } catch (error) {
            showAlert('receivingForm', 'Error loading vendors: ' + error.message, 'danger');
        }
    }

    // Load items
    async function loadItems() {
        try {
            const response = await fetch('/api/items');
            items = await response.json();
        } catch (error) {
            showAlert('receivingForm', 'Error loading items: ' + error.message, 'danger');
        }
    }

    // Add item row
    function addItemRow() {
        const container = document.getElementById('itemsContainer');
        const rowIndex = container.children.length;
        
        const itemRow = document.createElement('div');
        itemRow.className = 'item-row';
        itemRow.innerHTML = `
            <div class="form-group">
                <label class="form-label">Item Code</label>
                <div class="autocomplete-container">
                    <input type="text" class="form-control item-code-input" 
                           placeholder="Enter item code..." 
                           oninput="searchItems(this, ${rowIndex})"
                           onfocus="showAutocomplete(this, ${rowIndex})"
                           onblur="hideAutocomplete(this, ${rowIndex})">
                    <div class="autocomplete-dropdown" id="autocomplete-${rowIndex}"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-control quantity-input" min="1" value="1">
            </div>
            <div class="form-group">
                <label class="form-label">Unit Type</label>
                <select class="form-control unit-type-select">
                    <option value="cases">Cases</option>
                    <option value="pounds">Pounds</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Item Name</label>
                <input type="text" class="form-control item-name-display" readonly>
            </div>
            <button type="button" class="remove-item-btn" onclick="removeItemRow(this)" title="Remove Item">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(itemRow);
        updateReceiptPreview();
    }

    // Remove item row
    function removeItemRow(button) {
        const container = document.getElementById('itemsContainer');
        if (container.children.length > 1) {
            button.parentElement.remove();
            updateReceiptPreview();
        } else {
            showAlert('itemsContainer', 'At least one item is required', 'warning');
        }
    }

    // Search items with autocomplete
    function searchItems(input, rowIndex) {
        const searchTerm = input.value.toLowerCase();
        const dropdown = document.getElementById(`autocomplete-${rowIndex}`);
        
        if (searchTerm.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        const filteredItems = items.filter(item => 
            item.item_code.toLowerCase().includes(searchTerm) ||
            item.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredItems.length === 0) {
            dropdown.innerHTML = '<div class="autocomplete-item">No items found</div>';
        } else {
            dropdown.innerHTML = filteredItems.map(item => `
                <div class="autocomplete-item" onclick="selectItem('${item.item_code}', ${rowIndex})">
                    <div class="item-code">${item.item_code}</div>
                    <div class="item-name">${item.name}</div>
                </div>
            `).join('');
        }
        
        dropdown.style.display = 'block';
    }

    // Show autocomplete
    function showAutocomplete(input, rowIndex) {
        if (input.value.length >= 2) {
            searchItems(input, rowIndex);
        }
    }

    // Hide autocomplete
    function hideAutocomplete(input, rowIndex) {
        setTimeout(() => {
            const dropdown = document.getElementById(`autocomplete-${rowIndex}`);
            dropdown.style.display = 'none';
        }, 200);
    }

    // Select item from autocomplete
    function selectItem(itemCode, rowIndex) {
        const item = items.find(i => i.item_code === itemCode);
        if (item) {
            const row = document.querySelectorAll('.item-row')[rowIndex];
            row.querySelector('.item-code-input').value = item.item_code;
            row.querySelector('.item-name-display').value = item.name;
            
            const dropdown = document.getElementById(`autocomplete-${rowIndex}`);
            dropdown.style.display = 'none';
            
            updateReceiptPreview();
        }
    }

    // Update receipt preview
    function updateReceiptPreview() {
        const vendorSelect = document.getElementById('vendorSelect');
        const receivingDate = document.getElementById('receivingDate');
        const receiptVendor = document.getElementById('receiptVendor');
        const receiptDate = document.getElementById('receiptDate');
        const receiptItems = document.getElementById('receiptItems');
        const totalItems = document.getElementById('totalItems');
        
        // Update vendor and date
        const selectedVendor = vendors.find(v => v.id == vendorSelect.value);
        receiptVendor.textContent = `Vendor: ${selectedVendor ? selectedVendor.name : 'Not selected'}`;
        receiptDate.textContent = `Date: ${receivingDate.value || 'Not set'}`;
        
        // Update items
        const itemRows = document.querySelectorAll('.item-row');
        let totalQuantity = 0;
        let itemsHtml = '';
        
        itemRows.forEach(row => {
            const itemCode = row.querySelector('.item-code-input').value;
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            const unitType = row.querySelector('.unit-type-select').value;
            const itemName = row.querySelector('.item-name-display').value;
            
            if (itemCode && quantity > 0) {
                totalQuantity += quantity;
                itemsHtml += `
                    <div class="receipt-item">
                        <span class="receipt-label">${itemCode} - ${itemName}</span>
                        <span class="receipt-value">${quantity} ${unitType}</span>
                    </div>
                `;
            }
        });
        
        if (itemsHtml === '') {
            itemsHtml = '<div class="receipt-item"><span class="receipt-label">No items added yet</span><span class="receipt-value">-</span></div>';
        }
        
        receiptItems.innerHTML = itemsHtml;
        totalItems.textContent = totalQuantity;
    }

    // Process receiving
    async function processReceiving() {
        const vendorId = document.getElementById('vendorSelect').value;
        const receivingDate = document.getElementById('receivingDate').value;
        const photoFile = document.getElementById('receivingPhoto').files[0];
        
        if (!vendorId) {
            showAlert('receivingForm', 'Please select a vendor', 'warning');
            return;
        }
        
        if (!receivingDate) {
            showAlert('receivingForm', 'Please select a receiving date', 'warning');
            return;
        }
        
        const itemRows = document.querySelectorAll('.item-row');
        const itemsToReceive = [];
        
        for (let row of itemRows) {
            const itemCode = row.querySelector('.item-code-input').value;
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            const unitType = row.querySelector('.unit-type-select').value;
            
            if (itemCode && quantity > 0) {
                itemsToReceive.push({
                    item_code: itemCode,
                    quantity: quantity,
                    unit_type: unitType
                });
            }
        }
        
        if (itemsToReceive.length === 0) {
            showAlert('receivingForm', 'Please add at least one item', 'warning');
            return;
        }
        
        try {
            // If there's a photo, process items individually to attach photo to first item
            if (photoFile && itemsToReceive.length > 0) {
                // Process first item with photo
                const firstItem = itemsToReceive[0];
                const formData = new FormData();
                formData.append('item_code', firstItem.item_code);
                formData.append('quantity', firstItem.quantity);
                formData.append('vendor_id', vendorId);
                formData.append('unit_type', firstItem.unit_type);
                formData.append('photo', photoFile);
                
                const firstResponse = await fetch('/api/receive', {
                    method: 'POST',
                    body: formData
                });
                
                const firstResult = await firstResponse.json();
                
                if (!firstResult.lot_id) {
                    throw new Error(firstResult.error || 'Failed to receive first item');
                }
                
                // Process remaining items without photo
                if (itemsToReceive.length > 1) {
                    const remainingItems = itemsToReceive.slice(1);
                    const batchResponse = await fetch('/api/receive/batch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            vendor_id: parseInt(vendorId),
                            receiving_date: receivingDate,
                            items: remainingItems
                        })
                    });
                    
                    const batchResult = await batchResponse.json();
                    if (!batchResult.success) {
                        throw new Error(batchResult.error || 'Failed to receive remaining items');
                    }
                }
                
                // Show success message
                showAlert('receivingForm', `Successfully received ${itemsToReceive.length} items with photo documentation`, 'success');
            } else {
                // No photo, use batch processing
                const response = await fetch('/api/receive/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        vendor_id: parseInt(vendorId),
                        receiving_date: receivingDate,
                        items: itemsToReceive
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('receivingForm', `Successfully received ${result.successful} items and created ${result.lots_created} LOT codes`, 'success');
                    
                    // Store receipt for printing
                    currentReceipt = {
                        vendor_id: vendorId,
                        receiving_date: receivingDate,
                        items: itemsToReceive,
                        lots: result.received_lots
                    };
                    
                    // Clear form
                    clearForm();
                } else {
                    showAlert('receivingForm', 'Error processing receiving: ' + result.error, 'danger');
                }
            }
        } catch (error) {
            showAlert('receivingForm', 'Error processing receiving: ' + error.message, 'danger');
        }
    }

    // Clear form
    function clearForm() {
        document.getElementById('receivingForm').reset();
        document.getElementById('receivingPhoto').value = ''; // Clear photo input
        setDefaultDate();
        
        const container = document.getElementById('itemsContainer');
        container.innerHTML = '';
        addItemRow();
        
        updateReceiptPreview();
    }

    // Print receipt
    async function printReceipt() {
        if (!currentReceipt) {
            showAlert('receivingForm', 'No receipt to print. Please process receiving first.', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/receipt/vendor/${currentReceipt.vendor_id}/${currentReceipt.receiving_date}/pdf`);
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `receipt-${currentReceipt.vendor_id}-${currentReceipt.receiving_date}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('receivingForm', 'Receipt downloaded successfully', 'success');
            } else {
                showAlert('receivingForm', 'Error generating receipt', 'danger');
            }
        } catch (error) {
            showAlert('receivingForm', 'Error printing receipt: ' + error.message, 'danger');
        }
    }

    // Add event listeners for form updates
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('vendorSelect').addEventListener('change', updateReceiptPreview);
        document.getElementById('receivingDate').addEventListener('change', updateReceiptPreview);
    });
</script>
{% endblock %}
