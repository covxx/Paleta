<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - Label Printer Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/receiving">
                                <i class="fas fa-truck"></i> Receiving
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/orders">
                                <i class="fas fa-shopping-cart"></i> Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/orders/new">
                                <i class="fas fa-plus"></i> New Order
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/customers">
                                <i class="fas fa-users"></i> Customers
                            </a>
                        </li>
                        {% if session.admin_logged_in %}
                        <li class="nav-item">
                            <a class="nav-link" href="/quickbooks-import">
                                <i class="fab fa-quickbooks"></i> QB Import
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/label-designer">
                                <i class="fas fa-tags"></i> Label Designer
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="/admin">
                                <i class="fas fa-cog"></i> Admin
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Customer Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-primary" onclick="showAddCustomerModal()">
                            <i class="fas fa-plus"></i> Add Customer
                        </button>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchInput" class="form-control" placeholder="Search customers...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="statusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button id="clearFilters" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Customers Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Customers</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="customersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Payment Terms</th>
                                        <th>QB ID</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Customers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        
                        <!-- Basic Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="customerName" class="form-label">Customer Name *</label>
                                <input type="text" id="customerName" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="customerEmail" class="form-label">Email</label>
                                <input type="email" id="customerEmail" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="customerPhone" class="form-label">Phone</label>
                                <input type="tel" id="customerPhone" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="customerTaxId" class="form-label">Tax ID</label>
                                <input type="text" id="customerTaxId" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paymentTerms" class="form-label">Payment Terms</label>
                                <select id="paymentTerms" class="form-select">
                                    <option value="">Select payment terms...</option>
                                    <option value="Net 15">Net 15</option>
                                    <option value="Net 30">Net 30</option>
                                    <option value="Net 45">Net 45</option>
                                    <option value="Net 60">Net 60</option>
                                    <option value="Due on Receipt">Due on Receipt</option>
                                    <option value="Cash on Delivery">Cash on Delivery</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="quickbooksId" class="form-label">QuickBooks ID</label>
                                <input type="text" id="quickbooksId" class="form-control" placeholder="QB Customer ID">
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Billing Address -->
                        <h6>Billing Address</h6>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="billToName" class="form-label">Bill To Name</label>
                                <input type="text" id="billToName" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="billToAddress1" class="form-label">Address Line 1</label>
                                <input type="text" id="billToAddress1" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="billToAddress2" class="form-label">Address Line 2</label>
                                <input type="text" id="billToAddress2" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="billToCity" class="form-label">City</label>
                                <input type="text" id="billToCity" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="billToState" class="form-label">State</label>
                                <input type="text" id="billToState" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="billToZip" class="form-label">ZIP Code</label>
                                <input type="text" id="billToZip" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="billToCountry" class="form-label">Country</label>
                                <input type="text" id="billToCountry" class="form-control" value="USA">
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Shipping Address -->
                        <h6>Shipping Address</h6>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sameAsBilling" onchange="copyBillingToShipping()">
                                    <label class="form-check-label" for="sameAsBilling">
                                        Same as billing address
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="shipToName" class="form-label">Ship To Name</label>
                                <input type="text" id="shipToName" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="shipToAddress1" class="form-label">Address Line 1</label>
                                <input type="text" id="shipToAddress1" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="shipToAddress2" class="form-label">Address Line 2</label>
                                <input type="text" id="shipToAddress2" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="shipToCity" class="form-label">City</label>
                                <input type="text" id="shipToCity" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="shipToState" class="form-label">State</label>
                                <input type="text" id="shipToState" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="shipToZip" class="form-label">ZIP Code</label>
                                <input type="text" id="shipToZip" class="form-control">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="shipToCountry" class="form-label">Country</label>
                                <input type="text" id="shipToCountry" class="form-control" value="USA">
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Additional Information -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="customerNotes" class="form-label">Notes</label>
                                <textarea id="customerNotes" class="form-control" rows="3" placeholder="Additional notes about this customer..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="customerActive" checked>
                                    <label class="form-check-label" for="customerActive">
                                        Active Customer
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let customers = [];
        let currentCustomer = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterCustomers);
            document.getElementById('statusFilter').addEventListener('change', filterCustomers);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                customers = await response.json();
                displayCustomers(customers);
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function displayCustomers(customersToShow) {
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = '';

            customersToShow.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.phone || 'N/A'}</td>
                    <td>${customer.payment_terms || 'N/A'}</td>
                    <td>${customer.quickbooks_id || 'N/A'}</td>
                    <td>
                        <span class="badge bg-${customer.is_active ? 'success' : 'secondary'}">
                            ${customer.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${customer.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewCustomer(${customer.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredCustomers = customers;

            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(customer =>
                    customer.name.toLowerCase().includes(searchTerm) ||
                    (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                    (customer.phone && customer.phone.includes(searchTerm))
                );
            }

            if (statusFilter) {
                const isActive = statusFilter === 'active';
                filteredCustomers = filteredCustomers.filter(customer => customer.is_active === isActive);
            }

            displayCustomers(filteredCustomers);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            displayCustomers(customers);
        }

        function showAddCustomerModal() {
            currentCustomer = null;
            document.getElementById('customerModalTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('customerActive').checked = true;
            
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            modal.show();
        }

        function editCustomer(customerId) {
            currentCustomer = customers.find(c => c.id === customerId);
            if (!currentCustomer) return;

            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = currentCustomer.id;
            document.getElementById('customerName').value = currentCustomer.name;
            document.getElementById('customerEmail').value = currentCustomer.email || '';
            document.getElementById('customerPhone').value = currentCustomer.phone || '';
            document.getElementById('customerTaxId').value = currentCustomer.tax_id || '';
            document.getElementById('paymentTerms').value = currentCustomer.payment_terms || '';
            document.getElementById('quickbooksId').value = currentCustomer.quickbooks_id || '';
            
            // Billing address
            document.getElementById('billToName').value = currentCustomer.bill_to_name || '';
            document.getElementById('billToAddress1').value = currentCustomer.bill_to_address1 || '';
            document.getElementById('billToAddress2').value = currentCustomer.bill_to_address2 || '';
            document.getElementById('billToCity').value = currentCustomer.bill_to_city || '';
            document.getElementById('billToState').value = currentCustomer.bill_to_state || '';
            document.getElementById('billToZip').value = currentCustomer.bill_to_zip || '';
            document.getElementById('billToCountry').value = currentCustomer.bill_to_country || 'USA';
            
            // Shipping address
            document.getElementById('shipToName').value = currentCustomer.ship_to_name || '';
            document.getElementById('shipToAddress1').value = currentCustomer.ship_to_address1 || '';
            document.getElementById('shipToAddress2').value = currentCustomer.ship_to_address2 || '';
            document.getElementById('shipToCity').value = currentCustomer.ship_to_city || '';
            document.getElementById('shipToState').value = currentCustomer.ship_to_state || '';
            document.getElementById('shipToZip').value = currentCustomer.ship_to_zip || '';
            document.getElementById('shipToCountry').value = currentCustomer.ship_to_country || 'USA';
            
            document.getElementById('customerNotes').value = currentCustomer.notes || '';
            document.getElementById('customerActive').checked = currentCustomer.is_active;
            
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            modal.show();
        }

        function viewCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Create a simple view modal (you could enhance this)
            alert(`Customer: ${customer.name}\nEmail: ${customer.email || 'N/A'}\nPhone: ${customer.phone || 'N/A'}\nPayment Terms: ${customer.payment_terms || 'N/A'}`);
        }

        function copyBillingToShipping() {
            const sameAsBilling = document.getElementById('sameAsBilling').checked;
            
            if (sameAsBilling) {
                document.getElementById('shipToName').value = document.getElementById('billToName').value;
                document.getElementById('shipToAddress1').value = document.getElementById('billToAddress1').value;
                document.getElementById('shipToAddress2').value = document.getElementById('billToAddress2').value;
                document.getElementById('shipToCity').value = document.getElementById('billToCity').value;
                document.getElementById('shipToState').value = document.getElementById('billToState').value;
                document.getElementById('shipToZip').value = document.getElementById('billToZip').value;
                document.getElementById('shipToCountry').value = document.getElementById('billToCountry').value;
            }
        }

        async function saveCustomer() {
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                tax_id: document.getElementById('customerTaxId').value,
                payment_terms: document.getElementById('paymentTerms').value,
                quickbooks_id: document.getElementById('quickbooksId').value,
                bill_to_name: document.getElementById('billToName').value,
                bill_to_address1: document.getElementById('billToAddress1').value,
                bill_to_address2: document.getElementById('billToAddress2').value,
                bill_to_city: document.getElementById('billToCity').value,
                bill_to_state: document.getElementById('billToState').value,
                bill_to_zip: document.getElementById('billToZip').value,
                bill_to_country: document.getElementById('billToCountry').value,
                ship_to_name: document.getElementById('shipToName').value,
                ship_to_address1: document.getElementById('shipToAddress1').value,
                ship_to_address2: document.getElementById('shipToAddress2').value,
                ship_to_city: document.getElementById('shipToCity').value,
                ship_to_state: document.getElementById('shipToState').value,
                ship_to_zip: document.getElementById('shipToZip').value,
                ship_to_country: document.getElementById('shipToCountry').value,
                notes: document.getElementById('customerNotes').value,
                is_active: document.getElementById('customerActive').checked
            };

            if (!customerData.name) {
                alert('Customer name is required');
                return;
            }

            try {
                const customerId = document.getElementById('customerId').value;
                const url = customerId ? `/api/customers/${customerId}` : '/api/customers';
                const method = customerId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(customerId ? 'Customer updated successfully!' : 'Customer created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
                    loadCustomers();
                } else {
                    alert('Error saving customer: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                alert('Error saving customer');
            }
        }
    </script>
</body>
</html>
