{% extends "base.html" %}

{% block title %}Orders - ProduceFlow{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1><i class="fas fa-shopping-cart"></i> Orders</h1>
            <div class="version-info">
                <small class="text-white-50">v{{ version_info.display_version if version_info else '0.5.0' }}</small>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <nav class="header-nav">
                <a class="header-nav-link" href="/">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="header-nav-link" href="/receiving">
                    <i class="fas fa-truck"></i> Receiving
                </a>
                <a class="header-nav-link active" href="/orders">
                    <i class="fas fa-shopping-cart"></i> Orders
                </a>
            </nav>
            <div class="header-actions">
                <button class="btn btn-outline-light me-2" onclick="toggleTheme()" id="themeToggle">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                {% if not session.admin_logged_in %}
                    <a href="/admin/login" class="btn btn-light">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                {% else %}
                    <a href="/admin/logout" class="btn btn-outline-light">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Order Management</h2>
        <div class="btn-group">
            <a href="/orders/new" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Order
            </a>
        </div>
    </div>

                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="statusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="filled">Filled</option>
                            <option value="shipped">Shipped</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="customerFilter" class="form-select">
                            <option value="">All Customers</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" id="dateFilter" class="form-control" placeholder="Filter by date">
                    </div>
                    <div class="col-md-3">
                        <button id="clearFilters" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Orders</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="ordersTable">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Delivery Date</th>
                                        <th>Status</th>
                                        <th>Total</th>
                                        <th>QB Sync</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Order Details Modal -->
                <div class="modal fade" id="orderDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Order Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="orderDetailsContent">
                                <!-- Order details will be loaded here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="fillOrderBtn" style="display: none;">
                                    <i class="fas fa-boxes"></i> Fill Order
                                </button>
                                <button type="button" class="btn btn-success" id="syncQBBtn" style="display: none;">
                                    <i class="fab fa-quickbooks"></i> Sync to QB
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let orders = [];
        let customers = [];
        let currentOrderId = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            loadOrders();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('statusFilter').addEventListener('change', filterOrders);
            document.getElementById('customerFilter').addEventListener('change', filterOrders);
            document.getElementById('dateFilter').addEventListener('change', filterOrders);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('fillOrderBtn').addEventListener('click', fillOrder);
            document.getElementById('syncQBBtn').addEventListener('click', syncToQuickBooks);
        }

        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                customers = await response.json();
                
                const customerFilter = document.getElementById('customerFilter');
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    customerFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                orders = await response.json();
                displayOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function displayOrders(ordersToShow) {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';

            ordersToShow.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = 
                    '<td><strong>' + order.order_number + '</strong></td>' +
                    '<td>' + formatCustomerCell(order) + '</td>' +
                    '<td>' + formatDate(order.order_date) + '</td>' +
                    '<td>' + formatDate(order.requested_delivery_date) + '</td>' +
                    '<td>' + formatStatusCell(order.status) + '</td>' +
                    '<td><strong>$' + order.total_amount.toFixed(2) + '</strong></td>' +
                    '<td>' +
                        (order.quickbooks_synced ? 
                            '<span class="badge bg-success"><i class="fas fa-check"></i> Synced</span>' : 
                            '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>'
                        ) +
                    '</td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary me-1" onclick="showOrderDetails(' + order.id + ')">' +
                            '<i class="fas fa-eye"></i> View' +
                        '</button>' +
                        (order.status === 'pending' || order.status === 'in_progress' ? 
                            '<button class="btn btn-sm btn-success" onclick="fillOrder(' + order.id + ')">' +
                                '<i class="fas fa-boxes"></i> Fill' +
                            '</button>' : ''
                        ) +
                    '</td>';
                tbody.appendChild(row);
            });
        }

        function formatCustomerCell(order) {
            const customerName = order.customer_name || 'Unknown Customer';
            const customerEmail = order.customer_email || '';
            const customerPhone = order.customer_phone || '';
            
            // Generate initials from customer name
            const initials = customerName.split(' ')
                .map(word => word.charAt(0).toUpperCase())
                .join('')
                .substring(0, 2);
            
            let contactInfo = '';
            if (customerEmail || customerPhone) {
                contactInfo = '<small class="text-muted d-block">';
                if (customerEmail) contactInfo += '<i class="fas fa-envelope me-1"></i>' + customerEmail;
                if (customerEmail && customerPhone) contactInfo += '<br>';
                if (customerPhone) contactInfo += '<i class="fas fa-phone me-1"></i>' + customerPhone;
                contactInfo += '</small>';
            }
            
            return `
                <div class="d-flex align-items-center">
                    <div class="customer-avatar me-3">
                        <div class="avatar-circle bg-primary text-white">
                            ${initials}
                        </div>
                    </div>
                    <div class="customer-info">
                        <div class="fw-semibold">${customerName}</div>
                        ${contactInfo}
                    </div>
                </div>
            `;
        }

        function formatStatusCell(status) {
            const statusConfig = {
                'pending': {
                    icon: 'fas fa-clock',
                    color: 'warning',
                    text: 'Pending',
                    description: 'Awaiting processing'
                },
                'in_progress': {
                    icon: 'fas fa-spinner fa-spin',
                    color: 'info',
                    text: 'In Progress',
                    description: 'Being processed'
                },
                'filled': {
                    icon: 'fas fa-boxes',
                    color: 'primary',
                    text: 'Filled',
                    description: 'Ready for shipping'
                },
                'shipped': {
                    icon: 'fas fa-truck',
                    color: 'secondary',
                    text: 'Shipped',
                    description: 'In transit'
                },
                'completed': {
                    icon: 'fas fa-check-circle',
                    color: 'success',
                    text: 'Completed',
                    description: 'Delivered'
                },
                'cancelled': {
                    icon: 'fas fa-times-circle',
                    color: 'danger',
                    text: 'Cancelled',
                    description: 'Order cancelled'
                }
            };
            
            const config = statusConfig[status] || statusConfig['pending'];
            
            return `
                <div class="status-cell">
                    <span class="badge bg-${config.color} d-flex align-items-center" 
                          title="${config.description}">
                        <i class="${config.icon} me-1"></i>
                        ${config.text}
                    </span>
                </div>
            `;
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'in_progress': 'info',
                'filled': 'primary',
                'shipped': 'secondary',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const customerFilter = document.getElementById('customerFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredOrders = orders;

            if (statusFilter) {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }

            if (customerFilter) {
                filteredOrders = filteredOrders.filter(order => order.customer_id == customerFilter);
            }

            if (dateFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.order_date).toDateString();
                    const filterDate = new Date(dateFilter).toDateString();
                    return orderDate === filterDate;
                });
            }

            displayOrders(filteredOrders);
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('customerFilter').value = '';
            document.getElementById('dateFilter').value = '';
            displayOrders(orders);
        }

        async function showOrderDetails(orderId) {
            try {
                const order = orders.find(o => o.id === orderId);
                if (!order) return;

                currentOrderId = orderId;

                const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                const content = document.getElementById('orderDetailsContent');
                
                content.innerHTML = 
                    '<div class="row">' +
                        '<div class="col-md-6">' +
                            '<h6><i class="fas fa-info-circle me-2"></i>Order Information</h6>' +
                            '<div class="mb-3">' +
                                '<strong>Order Number:</strong><br>' +
                                '<span class="text-primary fs-5">' + order.order_number + '</span>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>Customer:</strong><br>' +
                                formatCustomerCell(order) +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>Order Date:</strong><br>' +
                                '<span class="text-muted">' + formatDate(order.order_date) + '</span>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>Delivery Date:</strong><br>' +
                                '<span class="text-muted">' + formatDate(order.requested_delivery_date) + '</span>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>Status:</strong><br>' +
                                formatStatusCell(order.status) +
                            '</div>' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<h6><i class="fas fa-dollar-sign me-2"></i>Financial Information</h6>' +
                            '<div class="mb-3">' +
                                '<strong>Subtotal:</strong><br>' +
                                '<span class="text-muted">$' + order.subtotal.toFixed(2) + '</span>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>Tax:</strong><br>' +
                                '<span class="text-muted">$' + order.tax_amount.toFixed(2) + '</span>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>Total:</strong><br>' +
                                '<span class="text-success fs-5 fw-bold">$' + order.total_amount.toFixed(2) + '</span>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<strong>QuickBooks:</strong><br>' +
                                (order.quickbooks_synced ? 
                                    '<span class="badge bg-success"><i class="fas fa-check"></i> Synced</span>' : 
                                    '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>'
                                ) +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<hr>' +
                    '<h6>Order Items</h6>' +
                    '<div class="table-responsive">' +
                        '<table class="table table-sm">' +
                            '<thead>' +
                                '<tr>' +
                                    '<th>Item</th>' +
                                    '<th>Ordered</th>' +
                                    '<th>Filled</th>' +
                                    '<th>Unit Price</th>' +
                                    '<th>Total</th>' +
                                    '<th>Status</th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody>' +
                                order.order_items.map(item => 
                                    '<tr>' +
                                        '<td><strong>' + item.item_name + '</strong></td>' +
                                        '<td><span class="badge bg-info">' + item.quantity_ordered + '</span></td>' +
                                        '<td><span class="badge bg-success">' + item.quantity_filled + '</span></td>' +
                                        '<td>$' + item.unit_price.toFixed(2) + '</td>' +
                                        '<td><strong>$' + item.total_price.toFixed(2) + '</strong></td>' +
                                        '<td>' + formatStatusCell(item.status) + '</td>' +
                                    '</tr>'
                                ).join('') +
                            '</tbody>' +
                        '</table>' +
                    '</div>' +
                    (order.notes ? '<hr><h6>Notes</h6><p>' + order.notes + '</p>' : '');

                // Show/hide action buttons based on order status
                const fillBtn = document.getElementById('fillOrderBtn');
                const syncBtn = document.getElementById('syncQBBtn');
                
                if (order.status === 'pending' || order.status === 'in_progress') {
                    fillBtn.style.display = 'inline-block';
                } else {
                    fillBtn.style.display = 'none';
                }

                if (!order.quickbooks_synced && (order.status === 'filled' || order.status === 'completed')) {
                    syncBtn.style.display = 'inline-block';
                } else {
                    syncBtn.style.display = 'none';
                }

                modal.show();
            } catch (error) {
                console.error('Error showing order details:', error);
                alert('Error loading order details');
            }
        }

        function fillOrder(orderId) {
            if (orderId) {
                window.location.href = '/orders/' + orderId + '/fill';
            } else if (currentOrderId) {
                window.location.href = '/orders/' + currentOrderId + '/fill';
            }
        }

        async function syncToQuickBooks() {
            if (!currentOrderId) return;

            try {
                const response = await fetch('/api/orders/' + currentOrderId + '/sync-quickbooks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Order synced to QuickBooks successfully!');
                    loadOrders(); // Reload orders to update sync status
                    bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();
                } else {
                    alert('Error syncing to QuickBooks: ' + result.error);
                }
            } catch (error) {
                console.error('Error syncing to QuickBooks:', error);
                alert('Error syncing to QuickBooks');
            }
        }
    </script>
</div>
{% endblock %}
