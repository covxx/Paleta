{% extends "base.html" %}

{% block title %}Dashboard - ProduceFlow{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
            <div class="version-info">
                <small class="text-white-50" id="versionDisplay" style="cursor: pointer;" onclick="showVersionDetails()" title="Click for version details">v0.5.0</small>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <nav class="header-nav">
                <a class="header-nav-link active" href="/">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="header-nav-link" href="/receiving">
                    <i class="fas fa-truck"></i> Receiving
                </a>
                <a class="header-nav-link" href="/orders">
                    <i class="fas fa-shopping-cart"></i> Orders
                </a>
            </nav>
            <div class="header-actions">
                <button class="btn btn-outline-light me-2" onclick="toggleTheme()" id="themeToggle">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                {% if not session.admin_logged_in %}
                    <a href="/admin/login" class="btn btn-light">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                {% else %}
                    <a href="/admin/logout" class="btn btn-outline-light">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-value" id="totalItems">-</div>
            <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stat-value" id="totalLots">-</div>
            <div class="stat-label">Total LOTs</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-truck"></i>
            </div>
            <div class="stat-value" id="totalVendors">-</div>
            <div class="stat-label">Vendors</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-print"></i>
            </div>
            <div class="stat-value" id="totalPrinters">-</div>
            <div class="stat-label">Printers</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="content-section">
        <div class="section-header">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        </div>
        <div class="section-body">
            <div class="quick-actions-grid">
                <a href="/receiving" class="quick-action-btn btn btn-primary">
                    <i class="fas fa-truck"></i>
                    <div>Receiving</div>
                    <small>Receive new inventory</small>
                </a>
                <a href="/orders/new" class="quick-action-btn btn btn-success">
                    <i class="fas fa-shopping-cart"></i>
                    <div>New Order</div>
                    <small>Create new order</small>
                </a>
                <a href="/label-designer" class="quick-action-btn btn btn-warning">
                    <i class="fas fa-tags"></i>
                    <div>Label Designer</div>
                    <small>Design labels</small>
                </a>
                <a href="/admin" class="quick-action-btn btn btn-info">
                    <i class="fas fa-cog"></i>
                    <div>Admin Panel</div>
                    <small>System management</small>
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="content-section">
        <div class="section-header">
            <h3><i class="fas fa-clock"></i> Recent Activity</h3>
        </div>
        <div class="section-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Item</th>
                            <th>User</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivity">
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading recent activity...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="content-section">
        <div class="section-header">
            <h3><i class="fas fa-heartbeat"></i> System Status</h3>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-6">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Database:</strong> Connected
                    </div>
                </div>
                <div class="col-6">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Printers:</strong> Online
                    </div>
                </div>
                <div class="col-6">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>QuickBooks:</strong> 
                        <span id="qbStatus">Checking...</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Auto-Sync:</strong> Active
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load dashboard data
    function loadDashboardData() {
        // Load stats
        Promise.all([
            fetch('/api/items').then(r => r.json()).catch(() => []),
            fetch('/api/lots').then(r => r.json()).catch(() => []),
            fetch('/api/vendors').then(r => r.json()).catch(() => []),
            fetch('/api/printers').then(r => r.json()).catch(() => [])
        ]).then(([items, lots, vendors, printers]) => {
            document.getElementById('totalItems').textContent = items.length || 0;
            document.getElementById('totalLots').textContent = lots.length || 0;
            document.getElementById('totalVendors').textContent = vendors.length || 0;
            document.getElementById('totalPrinters').textContent = printers.length || 0;
        }).catch(error => {
            console.error('Error loading dashboard data:', error);
        });

        // Load QuickBooks status
        fetch('/api/quickbooks/test-connection')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('qbStatus');
                if (data.success) {
                    statusElement.innerHTML = '<span class="text-success">Connected</span>';
                } else {
                    statusElement.innerHTML = '<span class="text-warning">Disconnected</span>';
                }
            })
            .catch(error => {
                document.getElementById('qbStatus').innerHTML = '<span class="text-danger">Error</span>';
            });

        // Load recent activity (placeholder)
        setTimeout(() => {
            const tbody = document.getElementById('recentActivity');
            tbody.innerHTML = 
                '<tr>' +
                    '<td>Just now</td>' +
                    '<td>Item received</td>' +
                    '<td>Sample Item #123</td>' +
                    '<td>Admin</td>' +
                    '<td><span class="badge badge-success">Success</span></td>' +
                '</tr>' +
                '<tr>' +
                    '<td>5 min ago</td>' +
                    '<td>Order created</td>' +
                    '<td>Order #456</td>' +
                    '<td>User</td>' +
                    '<td><span class="badge badge-info">Pending</span></td>' +
                '</tr>' +
                '<tr>' +
                    '<td>1 hour ago</td>' +
                    '<td>Label printed</td>' +
                    '<td>LOT-20250105-001</td>' +
                    '<td>System</td>' +
                    '<td><span class="badge badge-success">Success</span></td>' +
                '</tr>';
        }, 1000);
    }

    // Update version display
    function updateVersionDisplay() {
        const versionElement = document.getElementById('versionDisplay');
        if (versionElement) {
            // Fetch version info from API
            fetch('/api/version')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.version_info) {
                        const versionInfo = data.version_info;
                        let displayText = 'v' + (versionInfo.manual_version || '0.5.0');
                        
                        if (versionInfo.commit_hash) {
                            displayText += ' (' + versionInfo.commit_hash + ')';
                        }
                        
                        if (versionInfo.build_date) {
                            const buildDate = new Date(versionInfo.build_date);
                            displayText += ' - ' + buildDate.toLocaleDateString() + ' ' + buildDate.toLocaleTimeString();
                        }
                        
                        versionElement.textContent = displayText;
                    } else {
                        versionElement.textContent = 'v0.5.0';
                    }
                })
                .catch(error => {
                    console.error('Error fetching version info:', error);
                    versionElement.textContent = 'v0.5.0';
                });
        }
    }

    // Show version details modal
    function showVersionDetails() {
        fetch('/api/version')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.version_info) {
                    const versionInfo = data.version_info;
                    const modalHtml = `
                        <div class="modal fade" id="versionModal" tabindex="-1" aria-labelledby="versionModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="versionModalLabel">Version Information</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-6"><strong>Version:</strong></div>
                                            <div class="col-6">${versionInfo.manual_version || '0.5.0'}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Commit:</strong></div>
                                            <div class="col-6">${versionInfo.commit_hash || 'Unknown'}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Branch:</strong></div>
                                            <div class="col-6">${versionInfo.branch || 'Unknown'}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Build Date:</strong></div>
                                            <div class="col-6">${versionInfo.build_date ? new Date(versionInfo.build_date).toLocaleString() : 'Unknown'}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Status:</strong></div>
                                            <div class="col-6">${versionInfo.has_uncommitted ? 'Modified' : 'Clean'}</div>
                                        </div>
                                        <hr>
                                        <div class="text-center">
                                            <a href="/changelog" class="btn btn-primary">View Changelog</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('versionModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('versionModal'));
                    modal.show();
                    
                    // Clean up modal when hidden
                    document.getElementById('versionModal').addEventListener('hidden.bs.modal', function() {
                        this.remove();
                    });
                } else {
                    alert('Unable to load version information');
                }
            })
            .catch(error => {
                console.error('Error fetching version details:', error);
                alert('Error loading version information');
            });
    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateVersionDisplay();
        loadDashboardData();
    });
</script>
{% endblock %}
